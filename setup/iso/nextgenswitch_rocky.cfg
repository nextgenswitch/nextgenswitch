#version=RHEL9
# Kickstart for provisioning NextGenSwitch on Rocky Linux 9
lang en_US.UTF-8
keyboard us
timezone America/New_York --utc

%pre --interpreter=/bin/bash
exec < /dev/tty6 > /dev/tty6 2>&1
chvt 6

prompt_password() {
    local prompt=$1
    local value
    while true; do
        read -rsp "$prompt" value
        echo
        if [ -n "$value" ]; then
            printf '%s' "$value"
            return 0
        fi
        echo "Password cannot be empty." >&2
    done
}

while true; do
    ROOTPW=$(prompt_password "Enter root password: ") || exit 1
    CONFIRM=$(prompt_password "Confirm root password: ") || exit 1
    if [ "$ROOTPW" = "$CONFIRM" ]; then
        break
    fi
    echo "Passwords do not match. Try again." >&2
done

if command -v openssl >/dev/null 2>&1; then
    HASH=$(printf '%s' "$ROOTPW" | openssl passwd -6 -stdin)
    cat <<EOF >/tmp/rootpw.ks
rootpw --iscrypted $HASH
EOF
else
    cat <<EOF >/tmp/rootpw.ks
rootpw --plaintext $ROOTPW
EOF
fi

unset ROOTPW CONFIRM HASH
chvt 1
exec < /dev/tty1 > /dev/tty1 2>&1
%end

%include /tmp/rootpw.ks

network --bootproto=dhcp --device=ens160 --activate
network --hostname=nextgenswitch.local
user --name=nextgenswitch --password=nextgenswitch --groups=wheel --shell=/bin/bash
authselect --useshadow --passalgo=sha512
firewall --disabled
selinux --enforcing
bootloader --append="rhgb quiet crashkernel=1G-4G:192M,4G-64G:256M,64G-:512M"

clearpart --all --initlabel
autopart --type=lvm

%packages
@^minimal-environment
chrony
policycoreutils-python-utils
wget
git
zip
unzip
sox
lame
dnf-plugins-core
httpd
redis
supervisor
mariadb-server
sqlite
iptables-services
%end

%post --log=/root/nextgenswitch-post.log --erroronfail
set -euxo pipefail

ensure_network() {
    local iface=${1:-ens160}
    local attempts=0
    local max_attempts=10

    while (( attempts < max_attempts )); do
        if ip link show "$iface" >/dev/null 2>&1 && ip -4 addr show dev "$iface" | grep -q 'inet '; then
            if command -v ping >/dev/null 2>&1 && ping -c1 -W2 1.1.1.1 >/dev/null 2>&1; then
                return 0
            fi
            if command -v curl >/dev/null 2>&1 && curl -sf --connect-timeout 5 http://connectivitycheck.gstatic.com/generate_204 >/dev/null; then
                return 0
            fi
            if ! command -v ping >/dev/null 2>&1 && ! command -v curl >/dev/null 2>&1; then
                echo "Interface $iface has an IPv4 address but no connectivity checker is available; continuing." >&2
                return 0
            fi
        fi

        echo "Internet connectivity unavailable (attempt $((attempts + 1))/$max_attempts); trying to recover $iface." >&2
        if ip link show "$iface" >/dev/null 2>&1; then
            ip link set "$iface" up || true
        fi
        if command -v nmcli >/dev/null 2>&1; then
            nmcli device connect "$iface" || true
            nmcli device reapply "$iface" || true
        fi
        if command -v dhclient >/dev/null 2>&1; then
            dhclient -r "$iface" || true
            dhclient "$iface" || true
        fi

        sleep 5
        ((attempts++))
    done

    echo "Failed to establish internet connectivity on interface $iface after ${max_attempts} attempts." >&2
    exit 1
}

# Ensure DNS resolution during post configuration
cat <<'RESOLV' > /etc/resolv.conf
nameserver 1.1.1.1
nameserver 8.8.8.8
RESOLV

# Ensure the primary interface has working internet access before continuing with installs
ensure_network "ens160"

# Enable commonly required repositories
EPEL_RPM="https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
REMI_RPM="https://rpms.remirepo.net/enterprise/remi-release-9.rpm"
dnf install -y "$EPEL_RPM" "$REMI_RPM"

dnf install compat-openssl11

dnf module reset -y php

# Update metadata and install PHP 8.2 stack
MODULE_STREAM="php:remi-8.2"
dnf module enable -y "$MODULE_STREAM"
dnf install -y php-{bz2,cli,common,curl,intl,mbstring,opcache,process,zip,redis,xml,mysql,bcmath}

# Harden SELinux for outbound connections required by PHP/HTTPD
setsebool -P httpd_can_network_connect 1

# Disable firewalld in favour of iptables
systemctl disable firewalld || true
systemctl mask firewalld || true
systemctl enable iptables
systemctl enable httpd
systemctl enable supervisord
systemctl enable redis
systemctl enable mariadb

install_dir="/var/www/html/easypbx"
repo_url="https://github.com/nextgenswitch/nextgenswitch.git"
if [ ! -d "$install_dir" ]; then
    git clone "$repo_url" "$install_dir"
else
    echo "Skipping clone because $install_dir already exists" >> /root/nextgenswitch-post.log
fi

cd "$install_dir"

if [ -f storage.zip ]; then
    unzip -q storage.zip
fi

cp -f .env.example .env

# Install first-boot setup script and service
cp setup/iso/nextgenswitch_setup.sh /usr/local/bin/nextgenswitch_setup.sh
chmod +x /usr/local/bin/nextgenswitch_setup.sh
restorecon -v /usr/local/bin/nextgenswitch_setup.sh || true

cp setup/iso/nextgenswitch_setup.service /etc/systemd/system/nextgenswitch_setup.service
chmod 644 /etc/systemd/system/nextgenswitch_setup.service
restorecon -v /etc/systemd/system/nextgenswitch_setup.service || true

systemctl daemon-reload
systemctl enable nextgenswitch_setup.service

if [ -f composer.phar ]; then
    php composer.phar install --no-dev --optimize-autoloader --no-interaction
else
    echo "composer.phar missing; skipped dependency install" >> /root/nextgenswitch-post.log
fi
chcon -R -t httpd_sys_rw_content_t "$install_dir"
find "$install_dir/public" -type f -exec chmod 644 {} \;
find "$install_dir/public" -type d -exec chmod 755 {} \;
chmod -R 0777 storage

// need install libcxx

php artisan key:generate --force

%end

reboot
